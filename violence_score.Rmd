---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
library(tidyverse)
library(magrittr)

# features<-read.csv("features.csv")
```



Risk of Violence
Modelled age with a 4th degree polynomial. See broward_sheriff_data for our efforts to model it with a variety of exponentials (couldn't get it quite right so used a polynomial in the end).
```{r}
ggplot(features, aes(x=p_current_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age")

#modeling age with 4th degree polynomial
# age_poly=function(x){(0.000001212075045*x^4)-(0.000248255209699*x^3) +  (0.019071154980041*x^2) - (0.682313081713541*x) + (5.859159141993542)} #x=age
age_poly=function(x){0.00000126145944912785*x^4 - 0.00023448446315780700*x^3 + 0.01660174356697860000*x^2 - 0.56651100033213000000*x + 4.13182477973007000000}

plot(c(18:70),age_poly(c(18:70)))

age_subset=features%>%
           select(person_id, first, last, p_current_age, p_violence_raw)%>%
           filter(p_current_age>18&p_current_age<=70)%>%
           group_by(p_current_age)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)


ggplot(features, aes(x=p_current_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Regression Line Age vs Violence Score") +
     stat_function(fun = age_poly, colour="blue") +  
     xlim(18,70)

#looking at original
ggplot(features, aes(x=p_yrs5_felcount_person, y=p_violence_raw)) +
          geom_point(shape=1)  +
          ggtitle("Risk of Violence Raw vs Fel5yrs per Person")
       
#corrected with polynomial
poly_noage=features%>%
              select(person_id, p_current_age, p_age_first_offense,p_age_first_arrest,p_violence_raw)%>%
              mutate(score_no_age=p_violence_raw-age_poly(p_current_age))


```

Score vs age at first offense
Questions: 
1) What causes that upturned corner when I plot age of first offense against the score_no_age? It's reminds me of effect of when I plotted the current age against a score corrected with the exponential regression (poorly fitted at low range)
2) Why is there no explicit effect of p_current_age on the data? 
3) No algorithmic difference between points which have diff=0 (2 possibilities: 2nd offense within same year as 1st, or this IS their first) and points which are 0<diff<=5

```{r}
ggplot(features, aes(x=p_age_first_offense, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Offense")

ggplot(poly_noage, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw (No current age) vs Current Age")

ggplot(poly_noage, aes(x=p_age_first_offense, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Offense, no current age")
#checking the relationship b/w DISTANCE b/w ages, and score
ggplot(poly_noage, aes(x=p_current_age-p_age_first_offense, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Current Age-Age at First Offense")

ggplot(poly_noage, aes(x=p_current_age-p_age_first_offense, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Corrected Score vs Current Age-Age at First Offense")

#Checking what happens if I only plot the people with a current-age-age_first_offense of <=5, or if I don't plot them

age_off1_outsubset=features%>%
                  select(person_id, p_current_age,p_age_first_offense,p_violence_raw)%>%
                  filter(p_current_age-p_age_first_offense>5)%>%
                  mutate(score_no_age=p_violence_raw-age_poly(p_current_age))

small_diff=features%>%
                  select(person_id, p_current_age,p_age_first_offense,p_violence_raw)%>%
                  filter(p_current_age-p_age_first_offense<=5&p_current_age-p_age_first_offense>0)%>%
                  mutate(score_no_age=p_violence_raw-age_poly(p_current_age))

ggplot(age_off1_outsubset, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Age corrected score vs Age at First Offense, diff>5")

ggplot(small_diff, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Age corrected score vs Age at First Offense, diff>0 and diff<=5")

for (x in c(0:10)){
  diff=features%>%
                  select(person_id, p_current_age,p_age_first_offense,p_violence_raw)%>%
                  filter(p_current_age-p_age_first_offense==x)%>%
                  mutate(score_no_age=p_violence_raw-age_poly(p_current_age))

   print(
     ggplot(diff, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle(paste0("Score vs Age diff==",x))
   )
}


```

Same as above, but with p_age_first_arrest
```{r}
ggplot(features, aes(x=p_age_first_arrest, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Arrest")

ggplot(poly_noage, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw (No current age) vs Current Age")

ggplot(poly_noage, aes(x=p_age_first_arrest, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Arrest, no current age")

#checking the relationship b/w DISTANCE b/w ages, and score
ggplot(poly_noage, aes(x=p_current_age-p_age_first_arrest, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Current Age-Age at First Arrest")

ggplot(poly_noage, aes(x=p_current_age-p_age_first_arrest, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Corrected Score vs Current Age-Age at First Arrest")

first_arrest_low=features%>%
                   mutate(score_no_age=p_violence_raw-age_poly(p_current_age))%>%
                   # filter(p_age_first_arrest<=20)%>%
                   filter(p_current_age!=p_age_first_arrest)%>%
                   filter(p_felprop_violarrest==0&p_misdemassault_arrest<=3&p_felassault_arrest==0
                          &p_murder_arrest==0&p_famviol_arrest==0&p_sex_arrest==0
                          &p_yrs5_felcount_person<=1&p_misdem_count_5yrs<=3&cq_fail_appear_two_yr<=3)

ggplot(first_arrest_low, aes(x=p_age_first_arrest, y=p_violence_raw))+
  geom_point(shape=1)+
  ggtitle("Raw Score vs p_age_first_arrest, xlim<=20, no age=age@ first arrest")

ggplot(first_arrest_low, aes(x=p_age_first_arrest, y=score_no_age))+
  geom_point(shape=1)+
  ggtitle("Corrected Score vs p_age_first_arrest, xlim<=20, no age=age@ first arrest")
```

```{r}
ggplot(features, aes(x=p_yrs5_trafcount_person, y=p_violence_raw-age_poly(p_current_age)))+
  geom_point(shape=1)+
  ggtitle("Corrected Score vs 5 Yr Traffic")

```


```{r}
data_num=features%>%
                select(person_id,p_violence_raw,p_recid_raw,p_fail_to_appear_raw,
                       p_current_age,cq_fail_appear_two_yr,cq_fail_appear_two_plus,
                       p_yrs5_felcount_person, p_felony_count_person,cq_prior_conviction_F,
                       p_misdem_count_5yrs,p_misdem_count_person,cq_prior_conviction_M,
                       p_drug_count_5yrs,p_drug_count_person,
                       p_yrs5_trafcount_person,p_traffic_count_person,prior_conviction_T,
                       p_current_violent_offense,
                       p_prison_visits,p_prison_time,
                       p_jail_visits, p_jail_time,
                       cq_violent_conviction,
                       p_marital_status,p_sex,p_race,
                       p_numcases
                       )%>%
  
                mutate(corrected_age=age_poly(p_current_age))

write.csv(data_num,"data_num.csv")

```


Comparing generated COMPAS score vs original compas score 
With subtracted off age scores 
```{r}
predicted_COMPAS=features%>%
                  mutate(total_fail_appear=cq_fail_appear_two_yr+cq_fail_appear_two_plus,
                         corrected_age=age_poly(p_current_age),

```
#################################3
Alternative auto-gen approach 

Directly generating a linear regression using the converted age 
```{r}
total_linear.model <- lm(p_violence_raw~ 
                              corrected_age+
                              p_age_first_offense+
                              p_felprop_violarrest+
                              p_juv_fel_count+
                              p_felassault_arrest+
                              p_misdemassault_arrest+
                              p_murder_arrest+
                              p_famviol_arrest+
                              p_sex_arrest+
                              p_weapons_arrest+
                              total_fail_appear, 
                         predicted_COMPAS)

total_linear.model2 <- lm(p_violence_raw~ 
                              corrected_age+
                              corrected_age-p_age_first_offense+
                              p_felprop_violarrest+
                              p_juv_fel_count+
                              p_felassault_arrest+
                              p_misdemassault_arrest+
                              p_murder_arrest+
                              p_famviol_arrest+
                              p_sex_arrest+
                              p_weapons_arrest+
                              total_fail_appear, 
                         predicted_COMPAS)

total_linear.model3 <- lm(p_violence_raw~ 
                              corrected_age+
                              p_drug_count_5yrs+
                              p_yrs5_felcount_person+
                              p_misdem_count_5yrs+
                              total_fail_appear, 
                         predicted_COMPAS)

predicted_COMPAS=predicted_COMPAS%>%
                    mutate(lin_reg_total=predict(total_linear.model,.),
                           
                           lin_reg_total2=predict(total_linear.model2,.),
                           lin_reg_total3=predict(total_linear.model3,.)
                    )


ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total)) +
        geom_point(shape=1)  +
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score vs Actual V1 (New)")


ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score vs Actual V2 (With difference)")

ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total3)) +
        geom_point(shape=1)  +
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score vs Actual V3 (Old)")


```



```{r}
score_subset=predicted_COMPAS%>%
                  filter(p_violence_raw==-2)
  
ggplot(score_subset, aes(x=p_violence_raw, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2")
  
ggplot(score_subset, aes(x=p_current_age, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2, Predicted Score vs Age")

ggplot(score_subset, aes(x=p_current_age, y=p_violence_raw)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2, real Score vs Age")
                  
 
#WHat does this age poly actually do? Is it correct to just apply it to age and graph that? 
ggplot(features, aes(x=p_current_age, y=p_violence_raw-age_poly(p_current_age))) +
        geom_point(shape=1)  +
        ggtitle("Violence Raw and Current Age")

  
ggplot(features, aes(x=age_poly(p_current_age), y=p_violence_raw)) + #is linearizing correctly
        geom_point(shape=1)  +
        ggtitle("Violence Raw and Age_poly(Current Age)")

#######
# same as above using features2
# score_subset2=features2%>%
#                   filter(p_violence_raw==-2)
#   
# ggplot(score_subset2, aes(x=p_violence_raw, y=bottom_edge_pred)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2")
#   
# ggplot(score_subset2, aes(x=p_current_age, y=bottom_edge_pred)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2, Predicted Score vs Age")
# 
# ggplot(score_subset2, aes(x=p_current_age, y=p_violence_raw)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2, real Score vs Age")
                  
```
Idea: generate multiple linear regression using the subset of the "bottom edge" of all the linear relationships. 
```{r}
#no filtering of columns
features2=features%>%
           mutate(corrected_age=age_poly(p_current_age), 
                  total_fail_appear=cq_fail_appear_two_yr+cq_fail_appear_two_plus
                  )

age_bottom=features2%>%
           filter(p_current_age>18&p_current_age<=70)%>%
           group_by(corrected_age)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

drug_bottom=features2%>%
            group_by(p_drug_count_5yrs)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

fel5_bottom=features2%>%
            group_by(p_yrs5_felcount_person)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

misdem5_bottom=features2%>%
              group_by(p_misdem_count_5yrs)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

fail_bottom=features2%>%
              group_by(total_fail_appear)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)


bottom_edge_subset<-bind_rows(age_bottom, drug_bottom, fel5_bottom, misdem5_bottom, fail_bottom)
# View(bottom_edge_subset)

bottom_edge.model <- lm(p_violence_raw~corrected_age+p_drug_count_5yrs+
                                       p_yrs5_felcount_person+p_misdem_count_5yrs+
                                       total_fail_appear, 
                        bottom_edge_subset)

features2=features2%>%
              mutate(bottom_edge_pred=predict(bottom_edge.model, features2))

#old 
ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total)) +
        geom_point(shape=1)  +
        xlim(-4.5,0)+ylim(-4,0)+
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score (Old method)")

#new 
ggplot(features2, aes(x=p_violence_raw, y=bottom_edge_pred)) +
        geom_point(shape=1)  +
        xlim(-4.5,0)+ylim(-4,0)+

        annotate(x=1.5, y=1.5, label=round(cor(features2$bottom_edge_pred,
                                               features2$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Bottom Edge Predicted Violence Score vs Actual Violence Score")

```


