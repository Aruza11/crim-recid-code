---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
library(tidyverse)
library(magrittr)

# features<-read.csv("features.csv")
```



Risk of Violence
Modelled age with a 4th degree polynomial. See broward_sheriff_data for our efforts to model it with a variety of exponentials (couldn't get it quite right so used a polynomial in the end).
```{r}
ggplot(features, aes(x=p_current_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age")

#modeling age with 4th degree polynomial
# age_poly=function(x){(0.000001212075045*x^4)-(0.000248255209699*x^3) +  (0.019071154980041*x^2) - (0.682313081713541*x) + (5.859159141993542)} #x=age
age_poly=function(x){0.00000126145944912785*x^4 - 0.00023448446315780700*x^3 + 0.01660174356697860000*x^2 - 0.56651100033213000000*x + 4.13182477973007000000}

plot(c(18:70),age_poly(c(18:70)))

age_subset=features%>%
           select(person_id, first, last, p_current_age, p_violence_raw)%>%
           filter(p_current_age>18&p_current_age<=70)%>%
           group_by(p_current_age)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)


ggplot(features, aes(x=p_current_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Regression Line Age vs Violence Score") +
     stat_function(fun = age_poly, colour="blue") +  
     xlim(18,70)

#looking at original
ggplot(features, aes(x=p_yrs5_felcount_person, y=p_violence_raw)) +
          geom_point(shape=1)  +
          ggtitle("Risk of Violence Raw vs Fel5yrs per Person")
       
#corrected with polynomial
poly_noage=features%>%
              select(person_id, p_current_age, p_age_first_offense,p_violence_raw)%>%
              mutate(score_no_age=p_violence_raw-age_poly(p_current_age))


```

Score vs age at first offense
```{r}
ggplot(features, aes(x=p_age_first_offense, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Offense")

ggplot(poly_noage, aes(x=p_current_age, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Offense, no current age")

ggplot(poly_noage, aes(x=p_age_first_offense, y=score_no_age)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age at First Offense, no current age")

age_first_offense=features%>%
           select(person_id, first, last, p_age_first_offense, p_violence_raw)%>%
           filter(p_age_first_offense>=18&p_age_first_offense<=70)%>%
           group_by(p_age_first_offense)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

exponential.model <- lm(log(age_first_offense$p_violence_raw+5)~ age_first_offense$p_age_first_offense)
    cf=exponential.model%>% #cf stands for coefficients
       coef()%>%
       as.vector()
    exp_reg=function(x){exp(cf[2]*x+cf[1])-5} #x=age
    
ggplot(features, aes(x=p_age_first_offense, y=p_violence_raw)) +
     geom_point(shape=1)  +
     stat_function(fun = exp_reg, colour="blue") +  
     ggtitle("Risk of Violence Raw vs Age at First Offense+Exp_reg")
    

```


```{r}
#trying to generate regression line for 5yrfel now 
ggplot(poly_5yrfel, aes(x=p_yrs5_felcount_person, y=score_no_age)) +
        geom_point(shape=1)  +
        ggtitle("Risk of Violence Raw vs 5yrFel per Person, subtracted age polynomial")

corrected_5yrfel=features%>%
              select(person_id, p_current_age, p_yrs5_felcount_person,p_violence_raw)%>%
              mutate(score_no_age=p_violence_raw-exp_reg(p_current_age))

yrs5_fel_subset=corrected_5yrfel%>%
                group_by(p_yrs5_felcount_person)%>%
                arrange(score_no_age,.by_group=TRUE)%>%
                top_n(n=-1,wt=score_no_age)

fel_linear.model <- lm(yrs5_fel_subset$score_no_age~ yrs5_fel_subset$p_yrs5_felcount_person)
    #getting equation of model 
    summary(fel_linear.model)
    fel_cf=fel_linear.model%>% #cf stands for coefficients
       coef()%>%
      
       as.vector()
    lin_reg=function(x){fel_cf[2]*x+fel_cf[1]} #x=fel counts

violraw.fel_lin <- predict(fel_linear.model,list(felcount=yrs5_fel_subset$p_yrs5_felcount_person))
plot(yrs5_fel_subset$p_yrs5_felcount_person, yrs5_fel_subset$score_no_age)
lines(yrs5_fel_subset$p_yrs5_felcount_person, violraw.fel_lin,lwd=2, col = "blue", xlab = "5yr FelCounts", ylab = "Violence Raw Score")


ggplot(corrected_5yrfel, aes(x=p_yrs5_felcount_person, y=score_no_age)) +
        geom_point(shape=1)  +
        stat_function(fun = lin_reg, colour="blue") +
        ggtitle("5yrFel Regression Line vs Violence Score, subtracted age exp_reg")




```

Subtracting out both age and 5yrfel from 5yrmisdem didn't seem to work too well...Try generating a separate regression line for misdem counts 5 yrs? 
Generating model line for corrected 5_yr misdem (NOT subtracting out fel_score)
```{r}
corrected_5yrmisdem=features%>%
              select(person_id, p_current_age, p_misdem_count_5yrs,p_violence_raw)%>%
              filter(p_misdem_count_5yrs<=30)%>%
              mutate(score_no_age=p_violence_raw-exp_reg(p_current_age))

ggplot(corrected_5yrmisdem, aes(x=p_misdem_count_5yrs, y=score_no_age)) +
          geom_point(shape=1)  +
          ggtitle("Violence Score vs Corrected Misdem5yrs per Person (no age)")

yrs5_misdem_subset=corrected_5yrmisdem%>%
                group_by(p_misdem_count_5yrs)%>%
                arrange(score_no_age,.by_group=TRUE)%>%
                top_n(n=-1,wt=score_no_age)

misdem_linear.model <- lm(yrs5_misdem_subset$score_no_age~ yrs5_misdem_subset$p_misdem_count_5yrs)
    #getting equation of model 
    # summary(misdem_linear.model)
    misdem_cf=misdem_linear.model%>% #cf stands for coefficients
       coef()%>%
       as.vector()
    lin_reg2=function(x){misdem_cf[2]*x+misdem_cf[1]} #x=misdem counts

violraw.misdem_lin <- predict(misdem_linear.model,list(misdemcount=yrs5_misdem_subset$p_misdem_count_5yrs))
plot(yrs5_misdem_subset$p_misdem_count_5yrs, yrs5_misdem_subset$score_no_age)
lines(yrs5_misdem_subset$p_misdem_count_5yrs, violraw.misdem_lin,lwd=2, col = "blue", xlab = "5yr MisdemCounts", ylab = "Violence Raw Score")


ggplot(corrected_5yrmisdem, aes(x=p_misdem_count_5yrs, y=score_no_age)) +
        geom_point(shape=1)  +
        stat_function(fun = lin_reg2, colour="blue") +
        ggtitle("5yrMisdem Regression Line vs Violence Score, subtracted age exp_reg")



```

```{r}
ggplot(features, aes(x=cq_fail_appear_two_yr, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Failure to Appear in 2 yrs")


ggplot(features, aes(x=cq_fail_appear_two_plus, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Failure to Appear in 2yrs+")

ggplot(features, aes(x=cq_fail_appear_two_plus+cq_fail_appear_two_yr, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Failure to Appear Total")


corrected_appear=features%>%
              select(person_id, p_current_age, p_misdem_count_5yrs,p_violence_raw,
                     cq_fail_appear_two_yr,cq_fail_appear_two_plus)%>%
              mutate(total_fail_appear=cq_fail_appear_two_plus+cq_fail_appear_two_yr,
                     score_no_age=p_violence_raw-exp_reg(p_current_age))

ggplot(corrected_appear, aes(x=total_fail_appear, y=score_no_age)) +
          geom_point(shape=1)  +
          ggtitle("Violence Score vs Corrected Total Failures to Appear (no age)")

appear_subset=corrected_appear%>%
                filter(total_fail_appear<=5)%>%
                group_by(total_fail_appear)%>%
                arrange(score_no_age,.by_group=TRUE)%>%
                top_n(n=-1,wt=score_no_age)

appear_linear.model <- lm(appear_subset$score_no_age~ appear_subset$total_fail_appear)
     # summary(appear_linear.model)
       appear_cf=appear_linear.model%>% #cf stands for coefficients
       coef()%>%
       as.vector()
       
    lin_reg3=function(x){appear_cf[2]*x+appear_cf[1]} #x=failure to appear counts

violraw.appear_lin <- predict(appear_linear.model,list(appearcount=appear_subset$total_fail_appear))
plot(appear_subset$total_fail_appear, appear_subset$score_no_age)
lines(appear_subset$total_fail_appear, violraw.appear_lin,lwd=2, col = "blue", 
      xlab = "Failure to Appear Counts", ylab = "Violence Raw Score")


ggplot(corrected_appear, aes(x=total_fail_appear, y=score_no_age)) +
        geom_point(shape=1)  +
        stat_function(fun = lin_reg3, colour="blue") +
        ggtitle("Failure to Appear Regression Line vs Violence Score, subtracted age exp_reg")

```

```{r}
#drug count 5yrs 
ggplot(features, aes(x=p_drug_count_5yrs, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs 5yrDrug")

corrected_drug=features%>%
              select(person_id, p_current_age, 
                     p_yrs5_felcount_person,p_misdem_count_5yrs,
                     cq_fail_appear_two_yr,cq_fail_appear_two_plus,
                     p_drug_count_5yrs,
                     p_violence_raw)%>%
              mutate(total_fail_appear=cq_fail_appear_two_plus+cq_fail_appear_two_yr,
                     score_no_age=p_violence_raw-exp_reg(p_current_age),
                     score_no_age2=p_violence_raw-exp_reg(p_current_age)-
                                   lin_reg(p_yrs5_felcount_person)-
                                   lin_reg2(p_misdem_count_5yrs)-
                                   lin_reg3(total_fail_appear)
                    )
ggplot(corrected_drug, aes(x=p_drug_count_5yrs, y=score_no_age)) +
          geom_point(shape=1)  +
          ggtitle("Violence Score vs Corrected 5yrDrug (no age)")

ggplot(corrected_drug, aes(x=p_drug_count_5yrs, y=score_no_age2)) +
          geom_point(shape=1)  +
          ggtitle("Violence Score vs Corrected 5yrDrug (no age, fel, misdem, failure to appear)")

drug_subset=corrected_drug%>%
                group_by(p_drug_count_5yrs)%>%
                arrange(score_no_age,.by_group=TRUE)%>%
                top_n(n=-1,wt=score_no_age)

drug_linear.model <- lm(drug_subset$score_no_age~ drug_subset$p_drug_count_5yrs)
     # summary(drug_linear.model)
       drug_cf=drug_linear.model%>% #cf stands for coefficients
       coef()%>%
       as.vector()
       
    lin_reg4=function(x){drug_cf[2]*x+drug_cf[1]} #x=5yr drug counts

violraw.drug_lin <- predict(drug_linear.model,list(appearcount=drug_subset$p_drug_count_5yrs))
plot(drug_subset$p_drug_count_5yrs, drug_subset$score_no_age)
lines(drug_subset$p_drug_count_5yrs, violraw.drug_lin,lwd=2, col = "blue", 
      xlab = "5yrDrug Counts", ylab = "Violence Raw Score")


ggplot(corrected_drug, aes(x=p_drug_count_5yrs, y=score_no_age)) +
        geom_point(shape=1)  +
        stat_function(fun = lin_reg4, colour="blue") +
        ggtitle("5yrDrug Regression Line vs Violence Score, subtracted age exp_reg")

```

```{r}
data_num=features%>%
                select(person_id,p_violence_raw,p_recid_raw,p_fail_to_appear_raw,
                       p_current_age,cq_fail_appear_two_yr,cq_fail_appear_two_plus,
                       p_yrs5_felcount_person, p_felony_count_person,cq_prior_conviction_F,
                       p_misdem_count_5yrs,p_misdem_count_person,cq_prior_conviction_M,
                       p_drug_count_5yrs,p_drug_count_person,
                       p_yrs5_trafcount_person,p_traffic_count_person,prior_conviction_T,
                       p_current_violent_offense,
                       p_prison_visits,p_prison_time,
                       p_jail_visits, p_jail_time,
                       cq_violent_conviction,
                       p_marital_status,p_sex,p_race,
                       p_numcases
                       )%>%
  
                mutate(corrected_age=age_poly(p_current_age))

write.csv(data_num,"data_num.csv")

```


Comparing generated COMPAS score vs original compas score 
With subtracted off age scores 
```{r}
predicted_COMPAS=features%>%
                  mutate(total_fail_appear=cq_fail_appear_two_yr+cq_fail_appear_two_plus,
                         corrected_age=age_poly(p_current_age),
                         # pred_violence=age_poly(p_current_age),
                         # 
                         # pred_violence2=age_poly(p_current_age)+lin_reg(p_yrs5_felcount_person),
                         # 
                         # pred_violence3=age_poly(p_current_age)+lin_reg(p_yrs5_felcount_person)+
                         #                lin_reg2(p_misdem_count_5yrs),
                         # 
                         # pred_violence4=age_poly(p_current_age)+lin_reg(p_yrs5_felcount_person)+
                         #                lin_reg2(p_misdem_count_5yrs)+lin_reg3(total_fail_appear),
                         # 
                         # pred_violence5=age_poly(p_current_age)+lin_reg(p_yrs5_felcount_person)+
                         #                lin_reg2(p_misdem_count_5yrs)+lin_reg3(total_fail_appear)+
                         #                lin_reg4(p_drug_count_5yrs)
                         )


# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=p_violence_raw)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$p_violence_raw,
#                                                predicted_COMPAS$p_violence_raw),2), 
#                  geom="text")+
#         ggtitle("Actual Violence Score vs Actual")
# 
# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=pred_violence)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$pred_violence,
#                                                predicted_COMPAS$p_violence_raw),2), 
#                  geom="text")+
#         ggtitle("Predicted Violence Score vs Actual (age only)")
# 
# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=pred_violence2)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$pred_violence2,
#                                                predicted_COMPAS$p_violence_raw),2), 
#                  geom="text")+
#         ggtitle("Predicted Violence Score vs Actual (age, 5yrFel)")
# 
# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=pred_violence3)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$pred_violence3,
#                                                predicted_COMPAS$p_violence_raw),2), 
#                  geom="text")+
        # ggtitle("Predicted Violence Score vs Actual (age, 5yrFel, 5yrMisd)")
# 
# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=pred_violence4)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$pred_violence4,
#                                                predicted_COMPAS$p_violence_raw
#                                                ),2), 
#                  geom="text")+
#         ggtitle("Predicted Violence Score vs Actual (age, 5yrFel, 5yrMisd, Total Fail Appear)")
# 
# 
# ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=pred_violence5)) +
#         geom_point(shape=1)  +
#         annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$pred_violence5,
#                                                predicted_COMPAS$p_violence_raw),2), 
#                  geom="text")+
#         ggtitle("Predicted Violence Score vs Actual (age, 5yrFel, 5yrMisd, Total Fail Appear, 5yrDrug)")


```
#################################3
Alternative auto-gen approach 

Directly generating a linear regression using the converted age 
```{r}
total_linear.model <- lm(p_violence_raw~ 
                              corrected_age+
                              p_age_first_offense+
                              p_felprop_violarrest+
                              p_juv_fel_count+
                              p_felassault_arrest+
                              p_misdemassault_arrest+
                              p_murder_arrest+
                              p_famviol_arrest+
                              p_sex_arrest+
                              p_weapons_arrest+
                              total_fail_appear, 
                         predicted_COMPAS)

total_linear.model2 <- lm(p_violence_raw~ 
                              corrected_age+
                              p_drug_count_5yrs+
                              p_yrs5_felcount_person+
                              p_misdem_count_5yrs+
                              total_fail_appear, 
                         predicted_COMPAS)

# total_linear.model2 <- lm(p_violence_raw~ 
#                               corrected_age+
#                               corrected_age_off1+
#                               p_drug_count_5yrs+
#                               p_yrs5_felcount_person+
#                               p_misdem_count_5yrs+
#                               total_fail_appear+
#                               p_yrs5_trafcount_person+
#                               p_prison_visits+
#                               p_jail_visits+
#                               cq_prior_conviction_F+
#                               cq_prior_conviction_M, 
#                           predicted_COMPAS)

predicted_COMPAS=predicted_COMPAS%>%
                    mutate(lin_reg_total=predict(total_linear.model,.),
                           
                           lin_reg_total2=predict(total_linear.model2,.)
                    )


ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total)) +
        geom_point(shape=1)  +
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score vs Actual V1 (New)")


ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score vs Actual V2 (Old)")



```



```{r}
score_subset=predicted_COMPAS%>%
                  filter(p_violence_raw==-2)
  
ggplot(score_subset, aes(x=p_violence_raw, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2")
  
ggplot(score_subset, aes(x=p_current_age, y=lin_reg_total2)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2, Predicted Score vs Age")

ggplot(score_subset, aes(x=p_current_age, y=p_violence_raw)) +
        geom_point(shape=1)  +
        ggtitle("Raw Violence Score=-2, real Score vs Age")
                  
 
#WHat does this age poly actually do? Is it correct to just apply it to age and graph that? 
ggplot(features, aes(x=p_current_age, y=p_violence_raw-age_poly(p_current_age))) +
        geom_point(shape=1)  +
        ggtitle("Violence Raw and Current Age")

  
ggplot(features, aes(x=age_poly(p_current_age), y=p_violence_raw)) + #is linearizing correctly
        geom_point(shape=1)  +
        ggtitle("Violence Raw and Age_poly(Current Age)")

#######
# same as above using features2
# score_subset2=features2%>%
#                   filter(p_violence_raw==-2)
#   
# ggplot(score_subset2, aes(x=p_violence_raw, y=bottom_edge_pred)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2")
#   
# ggplot(score_subset2, aes(x=p_current_age, y=bottom_edge_pred)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2, Predicted Score vs Age")
# 
# ggplot(score_subset2, aes(x=p_current_age, y=p_violence_raw)) +
#         geom_point(shape=1)  +
#         ggtitle("Raw Violence Score=-2, real Score vs Age")
                  
```
Idea: generate multiple linear regression using the subset of the "bottom edge" of all the linear relationships. 
```{r}
#no filtering of columns
features2=features%>%
           mutate(corrected_age=age_poly(p_current_age), 
                  total_fail_appear=cq_fail_appear_two_yr+cq_fail_appear_two_plus
                  )

age_bottom=features2%>%
           filter(p_current_age>18&p_current_age<=70)%>%
           group_by(corrected_age)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

drug_bottom=features2%>%
            group_by(p_drug_count_5yrs)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

fel5_bottom=features2%>%
            group_by(p_yrs5_felcount_person)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

misdem5_bottom=features2%>%
              group_by(p_misdem_count_5yrs)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)

fail_bottom=features2%>%
              group_by(total_fail_appear)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-1,wt=p_violence_raw)


bottom_edge_subset<-bind_rows(age_bottom, drug_bottom, fel5_bottom, misdem5_bottom, fail_bottom)
# View(bottom_edge_subset)

bottom_edge.model <- lm(p_violence_raw~corrected_age+p_drug_count_5yrs+
                                       p_yrs5_felcount_person+p_misdem_count_5yrs+
                                       total_fail_appear, 
                        bottom_edge_subset)

features2=features2%>%
              mutate(bottom_edge_pred=predict(bottom_edge.model, features2))

#old 
ggplot(predicted_COMPAS, aes(x=p_violence_raw, y=lin_reg_total)) +
        geom_point(shape=1)  +
        xlim(-4.5,0)+ylim(-4,0)+
        annotate(x=1.5, y=1.5, label=round(cor(predicted_COMPAS$lin_reg_total,
                                               predicted_COMPAS$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Predicted Violence Score (Old method)")

#new 
ggplot(features2, aes(x=p_violence_raw, y=bottom_edge_pred)) +
        geom_point(shape=1)  +
        xlim(-4.5,0)+ylim(-4,0)+

        annotate(x=1.5, y=1.5, label=round(cor(features2$bottom_edge_pred,
                                               features2$p_violence_raw
                                               ),2), 
                 geom="text")+
        ggtitle("Bottom Edge Predicted Violence Score vs Actual Violence Score")

```


