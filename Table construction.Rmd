---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)

```


```{r}
# Connect to the database
db <- src_sqlite("compas-analysis/compas.db", create = TRUE)

# List all the tables
table_names <- src_tbls(db)
table_names
```

```{r}
casearrest_df <- tbl(db,"casearrest")
charge_df <- tbl(db,"charge")
compas_df <- tbl(db,"compas")
jailhistory_df <-tbl(db,"jailhistory")
prisonhistory_df <-tbl(db,"prisonhistory")
people_df<-tbl(db,"people")
```

Creating a new df from a subset of compas_df, altering names of some columns
```{r}
dfnew=select(compas_df,id,person_id, first, last, marital_status, screening_date,scale_id, type_of_assessment, raw_score, decile_score)
dfnew=rename(dfnew, person_score_id=id)
#View(dfnew)
```

Joining dfnew to relevant columns in people_df
```{r}
peoplenew=select(people_df,id, name,sex, race, dob, age, c_case_number)
peoplenew=rename(peoplenew,person_id=id)
dfnew=left_join(dfnew, peoplenew, by="person_id")
```

Joining dfnew to relevant columns in casearrest_df--COMMENTED OUT FOR NOW
```{r}
#casearrestnew=select(casearrest_df,person_id, case_number, arrest_id, arrest_date, #charge_degree)
#dfnew=left_join(dfnew, casearrestnew, by="person_id")
```

Performed check on jailhistorynew(sorting jailhistory_df by last name to see 
if I noticed any anomalies)
Joined dfnew to relevant columns in jailhistory_df
```{r}
jailhistorynew=select(jailhistory_df,person_id, in_custody, out_custody)
jailhistorynew=rename(jailhistorynew,jail_in_custody=in_custody, jail_out_custody=out_custody)
dfnew=left_join(dfnew, jailhistorynew, by="person_id")
```

Joined dfnew to relevant columns in charge_df
```{r}
chargenew=select(charge_df,person_id, case_type, case_number, offense_date, charge_number, charge_degree, charge, date_charge_filed, filing_type, filing_agency, statute)
dfnew=left_join(dfnew, chargenew, by="person_id")
```
Joined dfnew to relevant columns in prisonhistory_df
```{r}
prisonhistorynew=select(prisonhistory_df,person_id, in_custody, out_custody)
prisonhistorynew=rename(prisonhistorynew,prison_in_custody=in_custody, prison_out_custody=out_custody)
dfnew=left_join(dfnew, prisonhistorynew, by="person_id")
```

Recompute some of Compas' data and joining to dfnew (eventually)
```{r}

```


**features table code being; generated from dfnew**

Checking for all unique values for each relevant column
```{r}
#marital status: single and married 
mar=as_data_frame(distinct(select(dfnew, marital_status)))
sex=as_data_frame(distinct(select(dfnew, sex)))
race=as_data_frame(distinct(select(dfnew, race)))
charge_deg=as_data_frame(distinct(select(dfnew, charge_degree)))
charge=as_data_frame(distinct(select(dfnew, charge)))

```


categorical variables assigned numbers 1 and up as detailed in features table excel
static features--variables unique to each person, and which  I must assign numbers
```{r}
#use levels(dataset$column) to check what the vectors are
#should write a function for this later
#should go through person by person using a while true loop 
features=as_data_frame(distinct(select(dfnew, person_id, first,last,age,sex,marital_status,race)))

features$sex=factor(features$sex, levels=c("Male", "Female"), labels=c(1,2))
features$sex=as.numeric(as.character(features$sex))

features$marital_status=factor(features$marital_status, levels=c("Single", "Married", "Separated","Significant Other","Widowed","Divorced","Unknown"), labels=c(1,2,3,4,5,6,7))
features$marital_status=as.numeric(as.character(features$marital_status))

features$race=factor(features$race, levels=c("Caucasian", "African-American","Hispanic","Asian","Native American","Other"), labels=c(1,2,3,4,5,6))
features$race=as.numeric(as.character(features$race))

features
```

dynamic features-variables which will have a numeric value, and describe the charges/cases/crimes
```{r}
#number of felonies total 
dynamic<-dfnew %>%
  group_by(person_id) %>%
  summarise(num_felonies=sum(felonies=(f)))
  
  count()
 # summarise(tot_felonies=)
```

combination features (static and dynamic)
```{r}

```


**data visualization dfs--use name as a parameter**
```{r}
#person="miguel hernandez"
person="bilal williams"
case=filter(dfnew, name==person)
#case_names=colnames(case)

jailtb=as_data_frame(distinct(select(case,jail_in_custody,jail_out_custody)))
jailtb=rename(jailtb, incustody=jail_in_custody, outcustody=jail_out_custody)
jailtb=mutate(jailtb, event="jail")


prisontb=as_data_frame(distinct(select(case,prison_in_custody,prison_out_custody)))
prisontb=rename(prisontb, incustody=prison_in_custody, outcustody=prison_out_custody)
prisontb=mutate(prisontb,event="prison")


chargetb=as_data_frame(distinct(select(case,offense_date)))
chargetb=rename(chargetb, incustody=offense_date)
chargetb=mutate(chargetb,outcustody=incustody,event="charge")

eventstb=bind_rows(jailtb, prisontb,chargetb)
eventstb$incustody=as.Date(eventstb$incustody)
eventstb$outcustody=as.Date(eventstb$outcustody)

infotb=as_data_frame(distinct(select(case,name,person_id,sex,race,dob,age,marital_status,type_of_assessment,raw_score,decile_score)))
infotb$dob=as.Date(infotb$dob)
```

Visualization
```{r}
#check if use of logical operator "or" is correct
#linear spacing for x axis

vis=ggplot(eventstb, aes(colour=event)) + 
    geom_segment(aes(x=(subset(eventstb,event="prison"|"jail")$incustody),
                     xend=(subset(eventstb,event="prison"|"jail")$outcustody), 
                     y=event, yend=event),size=3)+
    geom_point(aes(x=(subset(eventstb,event="charge")$incustody),y=event))+
    labs(title=person,x="time")+
    scale_x_date(date_breaks="1 year", date_labels="%b %Y")

vis
infotb
```

TODO: 
Work on displaying the degree of each charge above the charge pts
Check validity of logical operator "or" in graph code
Get prison/jail time lengths to look bigger--change scale? 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
