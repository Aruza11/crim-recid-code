---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
library(stringr)
library(tidyverse)
  #includes core: ggplot2,dplyr,tidyr,readr,purrr,tibble
library(magrittr)
library(lubridate)
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/crim-recid-code")


```


```{r}
# Connect to the database
db <- src_sqlite("compas-analysis/compas.db", create = TRUE)

# List all the tables
table_names <- src_tbls(db)
table_names
```

```{r}
casearrest_df <- tbl(db,"casearrest")
charge_df <- tbl(db,"charge")
compas_df <- tbl(db,"compas")
jailhistory_df <-tbl(db,"jailhistory")
prisonhistory_df <-tbl(db,"prisonhistory")
people_df<-tbl(db,"people")
```


```{r}
fail_to_appear<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/fail_to_appear.csv")
convictions<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/convicted_from_disps.csv")
```

Writin individuals' compas score to file. I am doing this separately because I want the features table to be 1 row per person, which it cannot be if I add the compas scores (b/c each person has 3 scores for compas). *Note: some people have more than 1 set of COMPAS scores.*

```{r}
# compas_df%>%
    # select(person_id,person_id, first, last, type_of_assessment, raw_score, decile_score)%>%
    # as_data_frame()%>%
    # write.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/compas_scores.csv")
```

Creating a new df from a subset of compas_df, altering names of some columns
Starting with compas_df b/c I don't want people I don't have compas scores for
```{r}
dfnew=select(compas_df,id,person_id, first, last, marital_status, screening_date,scale_id, type_of_assessment, raw_score, decile_score)
dfnew=rename(dfnew, person_score_id=id)

#Joining dfnew to relevant columns in people_df
peoplenew=select(people_df,id, name,sex, race, dob, age, c_case_number)
peoplenew=rename(peoplenew,person_id=id)
dfnew=left_join(dfnew, peoplenew, by="person_id")

#Joining dfnew to relevant columns in casearrest_df--COMMENTED OUT FOR NOW
#casearrestnew=select(casearrest_df,person_id, case_number, arrest_id, arrest_date, #charge_degree)
#dfnew=left_join(dfnew, casearrestnew, by="person_id")

# Joined dfnew to relevant columns in jailhistory_df
jailhistorynew=select(jailhistory_df,person_id, in_custody, out_custody)
jailhistorynew=rename(jailhistorynew,jail_in_custody=in_custody, jail_out_custody=out_custody)
dfnew=left_join(dfnew, jailhistorynew, by="person_id")

#Joined dfnew to relevant columns in charge_df
chargenew=select(charge_df,person_id, case_type, case_number, offense_date, charge_number, charge_degree, charge, date_charge_filed, filing_type, filing_agency, statute)
dfnew=left_join(dfnew, chargenew, by="person_id")

#Joined dfnew to relevant columns in prisonhistory_df
prisonhistorynew=select(prisonhistory_df,person_id, in_custody, out_custody)
prisonhistorynew=rename(prisonhistorynew,prison_in_custody=in_custody, prison_out_custody=out_custody)

df_beforeCOMPAS=dfnew%>%
        left_join(.,prisonhistorynew, by="person_id")%>%
        mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
        filter(beforeCOMPAS==1)

df_afterCOMPAS=dfnew%>%
               left_join(.,prisonhistorynew, by="person_id")%>%
               mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
               filter(beforeCOMPAS==0)
```

NOTES: 1) df_beforeCOMPAS ONLY CONTAINS INFORMATION FROM BEFORE THE COMPAS EVALUATION (so we can perform predictive analysis on the code). 
2) All date columns should be coerced to Date class, i.e. 
dfnew$screening_date<-as.Date(dfnew$screening_date,format = "%Y-%m-%d %T") if converted to dataframe
3) Some people are not in charge_df, so they get filtered out of dfnew in the final filter(beforeCOMPAS==1) (because they have NAs for the offense date, beforeCOMPAS==1). Perhaps I should try to get this information from the broward dataset? 
4)count(dfnew):2279601

Storing dfnew in Data tables folder
Last wrote: 2/4/18; filtered s.t. beforeCOMPAS==1
```{r}
#setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables")
# dfnew%>%as_data_frame()%>%
        # write.csv(dfnew,"dfnew.csv")
```


**features table code being generated from dfnew**
Checking for all unique values for each relevant column. Also trying to figure out what the violent statutes are. 
```{r}
mar=as_data_frame(distinct(select(df_beforeCOMPAS, marital_status)))
sex=as_data_frame(distinct(select(df_beforeCOMPAS, sex)))
race=as_data_frame(distinct(select(df_beforeCOMPAS, race)))
charge_deg=as_data_frame(distinct(select(df_beforeCOMPAS, charge_degree)))
charge=as_data_frame(distinct(select(df_beforeCOMPAS, charge)))
statute=df_beforeCOMPAS%>%
          select(statute)%>%
          mutate(truncated=substr(statute,1,3),
          is_violent=if_else(substr(statute,1,3) %in% c("777","782","784","806","812","825","827"),1,0)
)%>%
          as_data_frame()
        
#sort(distinct(statute$truncated))
#distinct(filter(statute,truncated=="OCS"))

filter(df_beforeCOMPAS,statute=="ODRD631")

#ODVD463

df_beforeCOMPAS%>%filter(statute=="OHDD58")%>%
        select(first,last,case_number)%>%
        View()
```


categorical variables assigned numbers 1 and up as detailed in features table excel
static features--variables unique to each person, and which  I must assign numbers
```{r}
#use levels(dataset$column) to check what the vectors are
features=as_data_frame(distinct(df_beforeCOMPAS, person_id, first,last,age,sex,marital_status,race))

features$sex=factor(features$sex, levels=c("Male", "Female"), labels=c(1,2))
features$sex=as.numeric(as.character(features$sex))

features$marital_status=factor(features$marital_status, levels=c("Single", "Married", "Separated","Significant Other","Widowed","Divorced","Unknown"), labels=c(1,2,3,4,5,6,7))
features$marital_status=as.numeric(as.character(features$marital_status))

features$race=factor(features$race, levels=c("Caucasian", "African-American","Hispanic","Asian","Native American","Other"), labels=c(1,2,3,4,5,6))
features$race=as.numeric(as.character(features$race))
```

dynamic features-variables which will have a numeric value, and describe the charges/cases/crimes
*Possible issue (looked at person id 75): some people have what looks like duplicate charges but different case numbers. Are these actually different cases or is this a case where the same case got given 2 different case numbers? 

**Q: is checking #prison_in_custody enough to determine prison visits?
**Q: prison_time/jail_time: what if they were in jail 2x the exact same amount of time?

*Note*: (11714-11109)/11109 people were screened 2x
**distinct(person_id,charge_degree,case_number,charge) is how I have decided to distinguish unique "events" for each person. Check this criterion. 
*Note*: must call as_data_frame() before group_by function, or else I get a parser stack overflow error. Perhaps because it's trying to invoke the function on each element in the group_by? 
*Note*: do not use filter(is_felony==1) to remove entries because I want to distinguish between 0s and NAs (when I left join it later)
*Note*: applied abs() function to the difference of dates b/c the HMS portion of the dates is not in military time, so weird stuff with the hours can happen
#conduct check later on prison times data table (the original): does any 1 person have 2 stays in prison/jail that  are exactly the same length?

*Interesting fact: when the data is in a sqlite tbl, data is automatically typed, so subtracting dates works. However, if you convert to a dataframe, the data is given a type, so subtracting dates doesn't work unless you manually convert it Date class. *

dynamic_fel: 
.	felony count per person
.	checking for number of felonies that occurred at most 5 yrs before the screening date

dynamic_incarceration:
.	number of prison visits
.	total prison time (in days)
.	number of jail visits
.	total jail time (in days)
.	number of cases 

```{r}
dynamic_fel=df_beforeCOMPAS%>%
           distinct(person_id,charge_degree,case_number,charge,screening_date,date_charge_filed) %>%
           as_data_frame()%>%

           mutate(screening_date=ymd_hms(screening_date),
                  date_charge_filed=ymd_hms(date_charge_filed),
                  is_felony = if_else(substr(charge_degree,2,2)=="F",1,0),
                  years_bw = (as.numeric(screening_date-date_charge_filed,units="days")/365.25), 
                  fel_less_5yr = if_else(years_bw<=5&is_felony==1,1,0)
           )%>%
  #128639 rows
           distinct(person_id,charge_degree,case_number,charge,is_felony,fel_less_5yr)%>%
  #120141 rows--why? 
           group_by(person_id) %>%
             summarize(felony_count_person=sum(is_felony),
                       yrs5_felcount_person = sum(fel_less_5yr))

# View(head(dynamic_fel, 100))
 
dynamic_incarceration=df_beforeCOMPAS %>%
                        distinct(person_id,prison_in_custody,prison_out_custody,jail_in_custody,jail_out_custody,case_number)%>%
                        as_data_frame()%>%
                        mutate(prison_in_custody=ymd_hms(prison_in_custody),
                               prison_out_custody=ymd_hms(prison_out_custody),
                               
                               jail_in_custody=ymd_hms(jail_in_custody),
                               jail_out_custody=ymd_hms(jail_out_custody),

                               prison_time=abs(as.numeric
                                               (prison_out_custody-prison_in_custody,units="days")),
                               jail_time=abs(as.numeric
                                             (jail_out_custody-jail_in_custody,units="days"))
                               )%>%

                        group_by(person_id) %>%
                           summarize(prison_visits=n_distinct(prison_in_custody),
                                     prison_time=sum(unique(prison_time)),

                                     jail_visits=n_distinct(jail_in_custody),
                                     jail_time=sum(unique(jail_time)),
                                     numcases=n_distinct(case_number)
                                     )

View(head(dynamic_incarceration, 100))

#person id 55, negative jail time??
test_case_incarc=as_data_frame(filter(df_beforeCOMPAS, person_id==55))


person_with_most=filter(dynamic_fel,felony_count_person==max(dynamic_fel$felony_count_person))
#52 felonies
testperson=as_data_frame(filter(df_beforeCOMPAS, person_id==9761))
unique(testperson$case_number) 
#involved in 40 distinct cases



```


Calculating drug offenses in past 5 years
*categorized as drug offense if it was Statute 893
*same method as dynamic_fel

dynamic_drug: 
.	# drug offenses per person
.	# drug offenses within 5 years of COMPAS screening date
```{r}
dynamic_drug=df_beforeCOMPAS%>%
                 distinct(person_id,charge_degree,case_number,charge,screening_date,date_charge_filed,statute)%>%
                 as_data_frame()%>%

                 mutate(screening_date=ymd_hms(screening_date),
                        date_charge_filed=ymd_hms(date_charge_filed),
                        years_bw = (as.numeric(screening_date-date_charge_filed,units="days")/365.25), 
                        
                        is_drug= if_else(substr(statute,1,3)=="893",1,0),
                        is_drug_5yrs=if_else(years_bw<=5&is_drug==1,1,0)
                        )%>%
  
                 distinct(person_id,charge_degree,case_number,charge,is_drug,is_drug_5yrs) %>%

                 group_by(person_id) %>%
                    summarize(drug_count_person = sum(is_drug),
                              drug_count_5yrs=sum(is_drug_5yrs)
                              )

View(head(dynamic_drug,100))
```


dynamic_misdem: 
.	# misdemeanors per person
.	# misdemeanors within 5 years of COMPAS screening date
```{r}
dynamic_misdem=df_beforeCOMPAS%>%
                distinct(person_id,charge_degree,case_number,charge,screening_date,date_charge_filed)%>%
                as_data_frame()%>%

                mutate(screening_date=ymd_hms(screening_date),
                       date_charge_filed=ymd_hms(date_charge_filed),
                       years_bw = (as.numeric(screening_date-date_charge_filed,units="days")/365.25), 
                       is_misdem= if_else(substr(charge_degree,2,2)=="M",1,0),
                       is_misdem_5yrs=if_else(years_bw<=5&is_misdem,1,0))%>%
  
                distinct(person_id,charge_degree,case_number,charge,is_misdem,is_misdem_5yrs) %>%

                group_by(person_id) %>%
                   summarize(misdem_count_person = sum(is_misdem),
                             misdem_count_5yrs=sum(is_misdem_5yrs)
                             )
View(head(dynamic_misdem,100))

```

Arnold Foundation PSA features
.	Age at current arrest-already covered 
.	Current violent offence
.	Current violent offence & 20 yrs old or younger
.	Prior sentence to incarceration 


.	Pending charge at time of the offense

.	Prior misdemeanor conviction 
.	Prior felony conviction 
.	Prior violent conviction

.	Prior failure to appear pretrial in the past two years 
.	Prior failure to appear pretrial older than two years 

MUST DEAL WITH: person_id.x!=person_id.y,NAs (possibly requery?)

I will take "prior sentence to incarceration" to mean prison because jail is short-term; also, I think everybody in this dataset has gone to jail (because they have COMPAS evaluations), so incarceration would not be a useful feature if I counted jail. 
I will take "screening date" as current, and any offenses which occurred up to 30 days before this screening date as current offense (partially because 30 days seems reasonable to me and also to stay consistent with ProPublica's definition of recidivism, which defines a current case as within 30 days of the screening date).

arnold1: age at current arrest, current violent offence, current violent&20 or younger, prior sentence to incarceration 
*Age is in years, everything else is calculated in days
```{r}

arnold1<-df_beforeCOMPAS%>%
            distinct(person_id,screening_date,offense_date,dob,statute,prison_in_custody,prison_out_custody)%>%
            as_data_frame()%>%
            mutate(screening_date=ymd_hms(screening_date), 
                  #converting everything to lubridate date class
                  offense_date=ymd_hms(offense_date),
                  dob=ymd_hms(dob),
                  prison_in_custody=ymd_hms(prison_in_custody),
                  prison_out_custody=ymd_hms(prison_out_custody),
                  
                  current_age=(screening_date-dob)/365.25,
                  twenty_or_less=if_else(current_age<=20,1,0),
                  is_violent=if_else(substr(statute,1,3) %in% c("777","782","784","794","806","812","825","827"),1,0),
                  current_violent_offense=if_else(is_violent==1,1,0),
                  current_violent_twenty=if_else(is_violent==1&twenty_or_less==1,1,0),
                  
                  days_from_compas=as.numeric(screening_date-offense_date,units="days"),
                  is_current=if_else(days_from_compas<30,1,0),
                  
                  prison_time=as.period(prison_out_custody-prison_in_custody,units="days"),
                  in_prison=case_when(is.null(prison_in_custody) ~ NA,
                                      prison_out_custody-prison_in_custody>0 ~ TRUE,
                                      prison_out_custody-prison_in_custody<0 ~ FALSE)
                  )%>%

            group_by(person_id) %>%
              summarize(current_age=max(current_age),
                        current_violent_offense=if_else(sum(current_violent_offense)>0,1,0),
                        current_violent_twenty=if_else(sum(current_violent_twenty)>0,1,0),
                        prior_incarceration=if_else(sum(in_prison)>0,1,0)
                        )

View(head(arnold1,20))

```


PSA Features: Convictions
.	Prior misdemeanor conviction 
.	Prior felony conviction 
.	Prior violent conviction

a table with person_id,case_number,charge_number,charge_degree,convicted or not
ISSUE: Missing many dispositions; must reparse XML string
  
  Use case 11020953CF10A to debug this issue; should have 3 charges but I currently only have information for the first 
Code status (2/4/18): this chunk works, but because my convictions parsing is flawed, it has many NAs
```{r}
convictions_subset<-convictions%>%
                      select(case_number,Charge,convicted)%>%  
                      rename(charge_number=Charge)  

arnold2<-df_beforeCOMPAS%>%
            distinct(person_id,case_number,charge_number,charge_degree,charge,statute)%>%
  #must be data frame because have to left_join same 2 data structure
            as_data_frame()%>%
            left_join(convictions_subset, by=c("case_number","charge_number"))%>%

            mutate(is_felony = if_else(substr(charge_degree,2,2)=="F",1,0),
                   is_misdem= if_else(substr(charge_degree,2,2)=="M",1,0),
                   is_violent=if_else(substr(statute,1,3) %in% c("777","782","784","794","806","812","825","827"),1,0),

                   prior_conviction_F=if_else(is_felony==1&convicted==1,1,0),
                   prior_conviction_M=if_else(is_misdem==1&convicted==1,1,0),
                   violent_conviction=if_else(is_violent==1&convicted==1,1,0))%>%

            group_by(person_id)%>%
              summarise(
                        prior_conviction_F=if_else(sum(prior_conviction_F)>0,1,0),
                        prior_conviction_M=if_else(sum(prior_conviction_M)>0,1,0),
                        violent_conviction=if_else(sum(is_violent)>0,1,0)
                        )



View(head(arnold2))
                      
```


PSA Features: Failure to appear 
.	Prior failure to appear pretrial in the past two years 
.	Prior failure to appear pretrial older than two years 

Possible issue:  Why are some person_ids missing?
Note: must convert to dataframe type right away because left_join only works on tbls from the same source. Since I'm joining by case_number, must also make sure case_num columns are the same type. 

*days_bw calculated in days
```{r}
distinct_fail_to_appear<-fail_to_appear%>%
                        distinct(EventDate,case_num,fail_appeared)%>%
                        rename(case_number=case_num)
distinct_fail_to_appear$case_number=as.character(distinct_fail_to_appear$case_number)


arnold3<-df_beforeCOMPAS%>%
        distinct(person_id,case_number,screening_date)%>%
        as_data_frame()%>%
        left_join(distinct_fail_to_appear,by="case_number")%>%

        mutate(EventDate=mdy(EventDate,tz="UTC"), #format = "%m/%d/%Y"
               screening_date=ymd_hms(screening_date),#format = "%Y-%m-%d %T""
#mdy() fcn automatically converts to Date object, ymd_hms() function converts to POSIXt object, so 
#specify tz="UTC" to get mdy() to convert to POSIXt object
               days_bw=as.numeric(screening_date-EventDate,units="days"),
               logical=days_bw<=730,
               fail_appear_two_yr=if_else(logical&fail_appeared==1,1,0),
               fail_appear_two_plus=if_else(!logical&fail_appeared==1,1,0)
               )%>%
        select(person_id,case_number,fail_appear_two_yr,fail_appear_two_plus)%>%

        group_by(person_id)%>%
          summarise(fail_appear_two_yr=if_else(sum(fail_appear_two_yr)>0,1,0),
                    fail_appear_two_plus=if_else(sum(fail_appear_two_plus)>0,1,0)
                    )

View(head(arnold3,10))

```


Calculating recidivation from the dfnew entries after the COMPAS score was calculated. 
ProPublica/Northpointe's def: 
In a 2009 study examining the predictive power of its COMPAS score, Northpointe defined recidivism as "a finger-printable arrest involving a charge and a filing for any uniform crime reporting (UCR) code." We interpreted that to mean a criminal offense that resulted in a **jail booking** and took place after the crime for which the person was COMPAS scored.

It was not always clear, however, which criminal case was associated with an individual's COMPAS score. To match COMPAS scores with accompanying cases, we considered cases with arrest dates or charge dates within 30 days of a COMPAS assessment being conducted. In some instances, we could not find any corresponding charges to COMPAS scores. We removed those cases from our analysis.
Next, we sought to determine if a person had been charged with a new crime subsequent to crime for which they were COMPAS screened. We *did not count traffic tickets and some municipal ordinance violations as recidivism.* We did not count as recidivists people who were arrested for *failing to appear at their court hearings*, or people who were *later charged with a crime that occurred prior to their COMPAS screening*.

For *violent recidivism*, we used the FBI's definition of violent crime, a category that includes murder, manslaughter, forcible rape, robbery and aggravated assault.

For most of our analysis, we defined recidivism as a *new arrest within two years*. We based this decision on Northpointe's practitioners guide, which says that its recidivism score is meant to predict "a new misdemeanor or felony offense within two years of the COMPAS administration date."
In addition, a recent study of 25,000 federal prisoners' recidivism rates by the U.S. Sentencing Commission, which shows that most recidivists commit a new crime within the first two years after release (if they are going to commit a crime at all).

2 yr predictions, 3 yr predictions, arrested, whether went to jail, convictions, felony/misdemeanor/traffic, drug, violent, 

Notes: 
df_afterCOMPAS only has those cases which have offense_dates after the COMPAS screening date (computed in one of the first chunks). 
*in jail*: they are counted as in jail if they entered jail more than 30 days after their screening date
*violent recidivism*: Used Arnold PSA's definition of violent (very similar to the FBI's definition) to give each crime a violent/not violent label.
*later charged with crime that occurred prior to COMPAS screening*: accounted for by the fact that I'm filtering by offense_date, not charge_date.
*new arrest within two years*: offense_date-screening_date<=2

Corrections to make: for the in-jail criteria, must correct it to accountf or NAs in prison

```{r}
recid<-df_afterCOMPAS%>%
            distinct(person_id,case_number,charge_number,charge_degree,charge,statute,jail_in_custody,jail_out_custody,screening_date,offense_date)%>%
            filter(!is.na(jail_in_custody))%>%
            as_data_frame()%>%
  
            mutate(screening_date=ymd_hms(screening_date),
                   jail_in_custody=ymd_hms(jail_in_custody),
                   jail_out_custody=ymd_hms(jail_out_custody),
                   offense_date=ymd_hms(offense_date),
                   
                   is_felony = if_else(substr(charge_degree,2,2)=="F",1,0),
                   is_misdem= if_else(substr(charge_degree,2,2)=="M",1,0),
                   is_violent=if_else(substr(statute,1,3) %in% c("777","782","784","794","806","812","825","827"),1,0),
                   is_traffic = if_else(charge_degree=="(TCX)",1,0),
                   is_municipal= if_else((!substr(statute,1,1)%in%c(0:9))&!is.na(statute),1,0),
                   # jailtime_in_days=as.numeric(jail_out_custody-jail_in_custody,units="days"),
                   
                   days_bw_jailin_scrndate=as.numeric(jail_in_custody-screening_date,units="days"),
                   recid_jail=if_else((days_bw_jailin_scrndate>30)&!is.na(jail_in_custody)&!is.na(screening_date),1,0),
                   
                   days_bw=as.numeric(offense_date-screening_date,units="days"),
                   within_two_years=if_else(days_bw<720,1,0),
                   
                   propub_recid=if_else((recid_jail==1&within_two_years==1
                                         &is_traffic==0&is_municipal==0),1,0),
                   propub_violent_recid=if_else(propub_recid==1&is_violent==1,1,0)
                   )%>%

            group_by(person_id)%>%
                summarise(propub_recid=if_else(sum(propub_recid)>0,1,0),
                          propub_violent_recid=if_else(sum(propub_violent_recid)>0,1,0),
                          traffic_recid=if_else(sum(is_traffic)>0,1,0)
                        )

View(head(recid,100))
```


Merged all features tables together(static, dynamic, arnold)
```{r}

features<-features%>%
            left_join(dynamic_fel,by=NULL)%>%
            left_join(dynamic_incarceration,by=NULL)%>%
            left_join(dynamic_misdem,by=NULL)%>%
            left_join(dynamic_misdem,by=NULL)%>%
            left_join(arnold1,by=NULL)%>%
            # left_join(arnold2,by=person_id)%>% #add this later, this has problems
            left_join(arnold3,by=NULL)%>%
            left_join(recid, by=NULL)

```

Write features table to working directory because I want intermediate versions of this table synced on Github  
```{r}
write.csv(features,"features.csv")
```


**data visualization dfs
--use name as a parameter**
```{r}
#person="miguel hernandez"
#person="bilal williams"
#person="edward riddle"
person="aajah herrington"
case=filter(dfnew, name==person)
#case_names=colnames(case)

jailtb=as_data_frame(distinct(select(case,jail_in_custody,jail_out_custody)))
jailtb=rename(jailtb, incustody=jail_in_custody, outcustody=jail_out_custody)
jailtb=mutate(jailtb, event="jail")


prisontb=as_data_frame(distinct(select(case,prison_in_custody,prison_out_custody)))
prisontb=rename(prisontb, incustody=prison_in_custody, outcustody=prison_out_custody)
prisontb=mutate(prisontb,event="prison")


chargetb=as_data_frame(distinct(select(case,offense_date)))
chargetb=rename(chargetb, incustody=offense_date)
chargetb=mutate(chargetb,outcustody=incustody,event="charge")
#Note: these are not unique charges, these are the unique DAYS cases occured
#On an events visualization, even if somebody had 20 charges on 1 day, it will still
#only appear as 1 point so there's no point in doing anything else. 

eventstb=bind_rows(jailtb, prisontb,chargetb)
eventstb$incustody=as.Date(eventstb$incustody)
eventstb$outcustody=as.Date(eventstb$outcustody)

infotb=as_data_frame(distinct(select(case,name,person_id,sex,race,dob,age,marital_status,type_of_assessment,raw_score,decile_score)))
casenumbers=as_data_frame(distinct(select(case,name,person_id,case_number)))

infotb$dob=as.Date(infotb$dob)
```

Visualization
```{r}
#check if use of logical operator "or" is correct
#linear spacing for x axis

vis=ggplot(eventstb, aes(colour=event)) + 
    geom_segment(aes(x=(subset(eventstb,event="prison"|"jail")$incustody),
                     xend=(subset(eventstb,event="prison"|"jail")$outcustody), 
                     y=event, yend=event),size=3)+
    geom_point(aes(x=(subset(eventstb,event="charge")$incustody),y=event))+
    labs(title=person,x="time")+
    scale_x_date(date_breaks="1 year", date_labels="%b %Y")

vis
infotb
casenumbers
```

TODO: 
Work on displaying the degree of each charge above the charge pts
Check validity of logical operator "or" in graph code
Get prison/jail time lengths to look bigger--change scale? 

To do: proofread all of code, compute whether or not they recidivated (y_recidivated). Drugs, traffic crimes, broward-sheriff-data, add compas score, check latest screening date. Question: how do I define recidivated? Use Arnold PSA's definition of recidivation. 
