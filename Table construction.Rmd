---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
library(stringr)
library(tidyverse)
  #includes core: ggplot2,dplyr,tidyr,readr,purrr,tibble
library(magrittr)
 

```


```{r}
# Connect to the database
db <- src_sqlite("compas-analysis/compas.db", create = TRUE)

# List all the tables
table_names <- src_tbls(db)
table_names
```

```{r}
casearrest_df <- tbl(db,"casearrest")
charge_df <- tbl(db,"charge")
compas_df <- tbl(db,"compas")
jailhistory_df <-tbl(db,"jailhistory")
prisonhistory_df <-tbl(db,"prisonhistory")
people_df<-tbl(db,"people")
```

Creating a new df from a subset of compas_df, altering names of some columns
```{r}
dfnew=select(compas_df,id,person_id, first, last, marital_status, screening_date,scale_id, type_of_assessment, raw_score, decile_score)
dfnew=rename(dfnew, person_score_id=id)
#View(dfnew)
```

Joining dfnew to relevant columns in people_df
```{r}
peoplenew=select(people_df,id, name,sex, race, dob, age, c_case_number)
peoplenew=rename(peoplenew,person_id=id)
dfnew=left_join(dfnew, peoplenew, by="person_id")
```

Joining dfnew to relevant columns in casearrest_df--COMMENTED OUT FOR NOW
```{r}
#casearrestnew=select(casearrest_df,person_id, case_number, arrest_id, arrest_date, #charge_degree)
#dfnew=left_join(dfnew, casearrestnew, by="person_id")
```

Performed check on jailhistorynew(sorting jailhistory_df by last name to see 
if I noticed any anomalies)
Joined dfnew to relevant columns in jailhistory_df
```{r}
jailhistorynew=select(jailhistory_df,person_id, in_custody, out_custody)
jailhistorynew=rename(jailhistorynew,jail_in_custody=in_custody, jail_out_custody=out_custody)
dfnew=left_join(dfnew, jailhistorynew, by="person_id")
```

Joined dfnew to relevant columns in charge_df
```{r}
chargenew=select(charge_df,person_id, case_type, case_number, offense_date, charge_number, charge_degree, charge, date_charge_filed, filing_type, filing_agency, statute)
dfnew=left_join(dfnew, chargenew, by="person_id")
```
Joined dfnew to relevant columns in prisonhistory_df
```{r}
prisonhistorynew=select(prisonhistory_df,person_id, in_custody, out_custody)
prisonhistorynew=rename(prisonhistorynew,prison_in_custody=in_custody, prison_out_custody=out_custody)
dfnew=left_join(dfnew, prisonhistorynew, by="person_id")
```

Recompute some of Compas' data and joining to dfnew (eventually)
```{r}

```


**features table code being; generated from dfnew**

Checking for all unique values for each relevant column
```{r}
#marital status: single and married 
mar=as_data_frame(distinct(select(dfnew, marital_status)))
sex=as_data_frame(distinct(select(dfnew, sex)))
race=as_data_frame(distinct(select(dfnew, race)))
charge_deg=as_data_frame(distinct(select(dfnew, charge_degree)))
charge=as_data_frame(distinct(select(dfnew, charge)))
statute=as_data_frame(distinct(select(dfnew,statute)))

  
```


categorical variables assigned numbers 1 and up as detailed in features table excel
static features--variables unique to each person, and which  I must assign numbers
```{r}
#use levels(dataset$column) to check what the vectors are
#should write a function for this later
#should go through person by person using a while true loop 
features=as_data_frame(distinct(select(dfnew, person_id, first,last,age,sex,marital_status,race)))

features$sex=factor(features$sex, levels=c("Male", "Female"), labels=c(1,2))
features$sex=as.numeric(as.character(features$sex))

features$marital_status=factor(features$marital_status, levels=c("Single", "Married", "Separated","Significant Other","Widowed","Divorced","Unknown"), labels=c(1,2,3,4,5,6,7))
features$marital_status=as.numeric(as.character(features$marital_status))

features$race=factor(features$race, levels=c("Caucasian", "African-American","Hispanic","Asian","Native American","Other"), labels=c(1,2,3,4,5,6))
features$race=as.numeric(as.character(features$race))

features
```

dynamic features-variables which will have a numeric value, and describe the charges/cases/crimes
Problem: must distinguish distinct cases to get unique felonies
PERFORM CHECK (use person id 75-408 felonies??)
```{r}

dynamic_fel_incarceration=dfnew %>%
           distinct(person_id,offense_date,screening_date,date_charge_filed,charge_degree,prison_in_custody,prison_out_custody,jail_in_custody,jail_out_custody,case_number)%>%

           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           filter(beforeCOMPAS==1)%>%
           mutate(is_felony = if_else(substr(charge_degree,2,2)=="F",1,0)) %>%
   #        filter(is_felony==1)%>%
#           mutate(is_fel_5yrs=if_else(screening_date-date_charge_filed<=5,1,0))%>%

              group_by(person_id) %>%
                 summarize(felony_count_person = sum(is_felony),
  #                         fel_count_5yrs=sum(is_fel_5yrs),
                           prison_visits=n_distinct(prison_in_custody),
                           prison_time=sum(distinct(prison_out_custody-prison_in_custody)),

                           jail_visits=n_distinct(jail_in_custody),
                           jail_time=sum(distinct(jail_out_custody-jail_in_custody)),
                           numcases=n_distinct(case_number)
                    
                 )

#dynamic1=dynamic1%>%
 #        mutate(jailandprison_visits=prison_visits+jail_visits)%>%
  #       mutate(jailandprison_time=prison_time+jail_time)

dynamic_fel_incarceration
summarise(dynamic_fel_incarceration, Average = mean(numcases, na.rm = T))
#Q: is checking #prison_in_custody enough to determine prison visits? 
#Q: prison_time/jail_time: what if they were in jail 2x the exact same amount of time?

```

```{r}
#checking for number of felonies that occurred at most 5 yrs before the screening date
dynamic_fel5=dfnew%>%
           distinct(person_id,offense_date,screening_date,charge_degree,date_charge_filed)%>%
           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           mutate(is_felony = if_else(substr(charge_degree,2,2)=="F",1,0)) %>%
           filter(beforeCOMPAS==1)%>%
           filter(screening_date-date_charge_filed<=5)%>%
              group_by(person_id) %>%
                 summarize(yrs5_felcount_person = sum(is_felony)
                        
                           )
dynamic_fel5

```

Calculating drug offenses in past 5 years
```{r}
#idea: 1) Filter by statute number
#      2)include date in summarize table to get 5 yr drug offense

dynamic_drug=dfnew%>%
           distinct(person_id,offense_date,screening_date,date_charge_filed,statute)%>%
           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           mutate(is_drug= if_else(substr(statute,1,3)=="893",1,0)) %>%
           filter(beforeCOMPAS==1)%>%
           filter(is_drug==1)%>%
           mutate(is_drug_5yrs=if_else(screening_date-date_charge_filed<=5,1,0))%>%
              group_by(person_id) %>%
                 summarize(drug_count_person = sum(is_drug),
                           drug_count_5yrs=sum(is_drug_5yrs)
                           )
dynamic_drug

```

```{r}
dynamic_misdem=dfnew%>%
           distinct(person_id,offense_date,screening_date,date_charge_filed,charge_degree)%>%
           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           mutate(is_misdem= if_else(substr(charge_degree,2,2)=="M",1,0)) %>%
           filter(beforeCOMPAS==1)%>%
           filter(is_misdem==1)%>%
           mutate(is_misdem_5yrs=if_else(screening_date-date_charge_filed<=5,1,0))%>%
              group_by(person_id) %>%
                 summarize(misdem_count_person = sum(is_misdem),
                           misdem_count_5yrs=sum(is_misdem_5yrs)
                           )
dynamic_misdem

```

Arnold Foundation PSA features
.	Age at current arrest-already covered 
.	Current violent offence
.	Current violent offence & 20 yrs old or younger
.	Pending charge at time of the offense
.	Prior misdemeanor conviction 
.	Prior felony conviction 
.	Prior conviction (misdemeanor or felony) 
.	Prior violent conviction
.	Prior failure to appear pretrial in the past two years 
.	Prior failure to appear pretrial older than two years 
.	Prior sentence to incarceration 

Arnold Foundation: age at current arrest, current violent offence, current violent&20 or younger, prior sentence to incarceration 
```{r}
#to compute age at current arrest: screening-dob
#to compute current violent offence: use statutes 

arnold1=dfnew%>%
           distinct(person_id,offense_date,screening_date,date_charge_filed,charge_degree,dob,statute)%>%
  
           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           filter(beforeCOMPAS==1)%>%
              group_by(person_id) %>%
                 summarize(current_age=(screening_date-dob)
                           )
arnold1

felonystatutes=dfnew%>%
           distinct(person_id,offense_date,screening_date,date_charge_filed,charge_degree,dob,statute)%>%
           mutate(beforeCOMPAS=if_else(offense_date<=screening_date,1,0))%>%
           mutate(is_felony = if_else(substr(charge_degree,2,2)=="F",1,0)) %>%
           filter(is_felony==1)%>%
           filter(beforeCOMPAS==1)
          # distinct(statute) #why doesn't this work?
View(distinct(select(felonystatutes,statute)))
#save as CSV?

```


combine all features (static and dynamic)
```{r}

```


**data visualization dfs
--use name as a parameter**
```{r}
#person="miguel hernandez"
#person="bilal williams"
#person="edward riddle"
person="aajah herrington"
case=filter(dfnew, name==person)
#case_names=colnames(case)

jailtb=as_data_frame(distinct(select(case,jail_in_custody,jail_out_custody)))
jailtb=rename(jailtb, incustody=jail_in_custody, outcustody=jail_out_custody)
jailtb=mutate(jailtb, event="jail")


prisontb=as_data_frame(distinct(select(case,prison_in_custody,prison_out_custody)))
prisontb=rename(prisontb, incustody=prison_in_custody, outcustody=prison_out_custody)
prisontb=mutate(prisontb,event="prison")


chargetb=as_data_frame(distinct(select(case,offense_date)))
chargetb=rename(chargetb, incustody=offense_date)
chargetb=mutate(chargetb,outcustody=incustody,event="charge")
#Note: these are not unique charges, these are the unique DAYS cases occured
#On an events visualization, even if somebody had 20 charges on 1 day, it will still
#only appear as 1 point so there's no point in doing anything else. 

eventstb=bind_rows(jailtb, prisontb,chargetb)
eventstb$incustody=as.Date(eventstb$incustody)
eventstb$outcustody=as.Date(eventstb$outcustody)

infotb=as_data_frame(distinct(select(case,name,person_id,sex,race,dob,age,marital_status,type_of_assessment,raw_score,decile_score)))
casenumbers=as_data_frame(distinct(select(case,name,person_id,case_number)))

infotb$dob=as.Date(infotb$dob)
```

Visualization
```{r}
#check if use of logical operator "or" is correct
#linear spacing for x axis

vis=ggplot(eventstb, aes(colour=event)) + 
    geom_segment(aes(x=(subset(eventstb,event="prison"|"jail")$incustody),
                     xend=(subset(eventstb,event="prison"|"jail")$outcustody), 
                     y=event, yend=event),size=3)+
    geom_point(aes(x=(subset(eventstb,event="charge")$incustody),y=event))+
    labs(title=person,x="time")+
    scale_x_date(date_breaks="1 year", date_labels="%b %Y")

vis
infotb
casenumbers
```

TODO: 
Work on displaying the degree of each charge above the charge pts
Check validity of logical operator "or" in graph code
Get prison/jail time lengths to look bigger--change scale? 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
