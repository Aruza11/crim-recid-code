---
title: "Broward Sheriff Data Comparison"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).



```{r}
library(tidyverse)
library(magrittr)
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/crim-recid-code")

```

Reading in pretrial prescreen dataset which the Broward Sheriff's Office shared with ProPublica
```{r}
pretrialscreen_2013_2014<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/Compas_Jan2013_Dec2014_LegalRequest_PRETRIAL AND PRESCREEN.csv")

pretrialscreen_2014_2017<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/Compas_Jan2014_Dec2017_LegalRequest_PRETRIAL AND PRESCREEN.csv")

pretrialscreen<-bind_rows(pretrialscreen_2013_2014,pretrialscreen_2014_2017)
# pretrialscreen$Screening_Date<-as.Date(pretrialscreen$Screening_Date,format="%m/%d/%Y %T")
#the above doesn't work for some reason

rm(pretrialscreen_2013_2014,pretrialscreen_2014_2017)
 
scattertbl1<-filter(pretrialscreen,DisplayText=="Risk of Violence")
scattertbl2<-filter(pretrialscreen,DisplayText=="Risk of Recidivism")
scattertbl3<-filter(pretrialscreen,DisplayText=="Risk of Failure to Appear")

features<-read.csv("features.csv")

```

```{r}
ggplot(pretrialscreen, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Pretrial Prescreen Dataset")

boxplot(RawScore~DisplayText,data=pretrialscreen, main="Distribution of Raw Scores for Each Screening Type", xlab="DisplayText", ylab="RawScore")



print("mean,25th quartile, median, 75th quartile,min,max")
print("Risk of Violence min max raw scores:")
fivenum(scattertbl1$RawScore)


ggplot(scattertbl1, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Scores")

print("Risk of Recidivism min max raw scores:")
fivenum(scattertbl2$RawScore)

ggplot(scattertbl2, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Scores")


print("Risk of Failure to Appear min max raw scores:")
fivenum(scattertbl1$RawScore)

ggplot(scattertbl3, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Scores")



```

Comparison with data from ProPublica, more summary statistics
```{r}
pretrialscreen%>%
        select(LegalStatus)%>%
        unique()

pretrialscreen%>%
        select(AssessmentReason)%>%
        unique()

pretrialscreen%>%
        select(DisplayText)%>%
        unique()


nonprescreen=filter(pretrialscreen,LegalStatus!="Pretrial")
prescreen=filter(pretrialscreen,LegalStatus=="Pretrial")
#compare to people from propublica dataset 

print("min max Screening Dates")
min(pretrialscreen$Screening_Date)
max(pretrialscreen$Screening_Date)


#people who have same raw score, but different decile score. Work with scattertbl3 first, because has integer score values 

# filter(scattertbl3, )

```

LegalStatus
<chr>
1	Conditional Release			
10	Post Sentence			
205	Pretrial			
43143	Other			
4 rows

AssessmentReason
<fctr>
1	Intake			
1 row
 
 
DisplayText
<fctr>
1	Risk of Violence			
2	Risk of Recidivism			
3	Risk of Failure to Appear			
3 rows


Age, number of priors, number of misdemeanors, number of felonies, expect a decision tree (scattered bunches on scatterplot)

Plot people with similar criminal histories, plot age vs compas score
Similar: similar number of  priors, similar number of offenses, 

Issue: we only have the criminal history information for people in ProPublica's dataset, and ProPublica only looked at pretrial people. Therefore we can only look at the Compas algorithm for pretrial screening (and in fact, we will be looking at the features table I generated in an earlier bit of code)

```{r}

ggplot(features, aes(x=p_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age")


ggplot(features, aes(x=p_age, y=p_recid_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Raw vs Age")


ggplot(features, aes(x=p_age, y=p_fail_to_appear_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Raw vs Age")

############

ggplot(features, aes(x=p_age, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Age")

ggplot(features, aes(x=p_age, y=recid_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Score vs Age")

ggplot(features, aes(x=p_age, y=fail_to_appear_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Score vs Age")


```
Find function that models the "lower edge"
From rdoc on top_n: n is the number of rows to return. If x is grouped, this is the number of rows per group. Will include more than n rows if there are ties.
If n is positive, selects the top n rows. If negative, selects the bottom n rows.

```{r}
age_subset=features%>%
           select(person_id, first, last, p_age, p_violence_raw)%>%
           filter(p_age>18&p_age<=70)%>%
           group_by(p_age)%>%
              arrange(p_violence_raw,.by_group=TRUE)%>%
              top_n(n=-5,wt=p_violence_raw)

# View(age_subset)

# ggplot(age_subset,aes(x=age,y=violence_raw+5)) +
#       geom_point(shape=1)+
#       geom_smooth(method="glm",
#                   method.args=list(family=gaussian(link="log")))

exponential.model <- lm(log(age_subset$p_violence_raw+5)~ age_subset$p_age)
    
    #getting equation of model
    summary(exponential.model)
    cf=exponential.model%>% #cf stands for coefficients
       coef()%>%
       as.vector()
    exp_reg=function(x){exp(cf[2]*x+cf[1])-5} #x=age
    exp_reg_improved=function(x){exp(-0.0294475*x+1.5340542)-5}
    
    # plot(exp_reg,1,70) #the equation of the exponential regression 
 
#plotting the regression line on top of age_subset points
violraw.exponential2 <- exp(predict(exponential.model,list(Age=age_subset$age)))
plot(age_subset$p_age, age_subset$p_violence_raw)
lines(age_subset$p_age, violraw.exponential2-5,lwd=2, col = "red", xlab = "Age", ylab = "Violence Raw Score")

#plotting the regression line on top of ALL points
ggplot(features, aes(x=p_age, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Regression Line Age vs Violence Score") +
     stat_function(fun = exp_reg, aes(colour="red")) + 
     stat_function(fun=exp_reg_improved, aes(colour="blue"))
       # geom_line(aes(colour="blue"))+

     xlim(18,70)



```

Subtracting out variables: according to Sheriff's office, factors are age, total priors, prior failures to appear at scheduled court appearances, history of illegal substance use, mental health, time at previous or prior residences

Trying to subtract out age from violence score based on regression

*Total misdemeanors and felonys 
```{r}

exp_reg=function(x){exp(cf[2]*x+cf[1])-5} #x=age
features$p_age=as.integer(features$p_age)
   

#original plot is w=0

for(w in c(0,.5,1,2,5,10,20)){

    no_age=features%>%
              select(person_id, p_age, p_felony_count_person,p_misdem_count_person,p_violence_raw)%>%
              # filter(p_age>=18&p_age<=20)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-w*exp_reg(p_age))
    
      #plot with no age  
    print(ggplot(no_age, aes(x=p_felony_count_person+p_misdem_count_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs Felonies per Person (weight",w,")"))
          )
}

for(a in c(20,24,28,32,36,40,44)){
    no_age=features%>%
              select(person_id, p_age, p_felony_count_person,p_misdem_count_person,p_violence_raw)%>%
              filter(p_age>=(a-2)&p_age<=(a+2))%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    print(no_age)
    print(ggplot(no_age, aes(x=p_felony_count_person+p_misdem_count_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs Fel+Misd per Person (age range ",a-2,"-",a+2,")"))
          )
}

for(a2 in c(18,20,22,24,26,28,30)){
    no_age=features%>%
              select(person_id, p_age, p_felony_count_person,p_misdem_count_person,p_violence_raw)%>%
              filter(p_age==a2)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    
    print(ggplot(no_age, aes(x=p_felony_count_person+p_misdem_count_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs Fel+Misd per Person (age ",a2,")"))
          )
}

```

Seems to be pretty clear relationship b/w violence score raw and number of felonies within five years.
But it feels like the relationship actually gets less clear when I subtract out age. Perhaps do a regression line based only on num fel within 5 yrs? 
*Note: weight 2 actually seems to make the relationship clearer
```{r}
exp_reg=function(x){exp(cf[2]*x+cf[1])-5} #x=age

for(w in c(0,.5,1,2,5,10,20)){

    no_age=features%>%
              select(person_id, p_age, p_yrs5_felcount_person,p_violence_raw)%>%
              # filter(p_age>=18&p_age<=20)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-w*exp_reg(p_age))
    
      #plot with no age  
    print(ggplot(no_age, aes(x=p_yrs5_felcount_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs Fel5yrs per Person (weight",w,")"))
          )
}

for(a in c(20,24,28,32,36,40,44)){
    no_age=features%>%
              select(person_id, p_age, p_yrs5_felcount_person,p_violence_raw)%>%
              filter(p_age>=(a-2)&p_age<=(a+2))%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    print(no_age)
    print(ggplot(no_age, aes(x=p_yrs5_felcount_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs 5yrFel per Person (age range ",a-2,"-",a+2,")"))
          )
}

for(a2 in c(18,20,22,24,26,28,30)){
    no_age=features%>%
              select(person_id, p_age, p_yrs5_felcount_person,p_violence_raw)%>%
              filter(p_age==a2)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    
    print(ggplot(no_age, aes(x=p_yrs5_felcount_person, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs 5yrFel per Person (age ",a2,")"))
          )
}

  

```

Checking other variables the Sheriff's office told us were relevant
Failures to appear: again, weight 2 looks promising. 
```{r}
exp_reg=function(x){exp(cf[2]*x+cf[1])-5} #x=age

for(w in c(0,.5,1,2,5,10,20)){

    no_age=features%>%
              select(person_id, p_age, cq_fail_appear_two_yr,p_violence_raw)%>%
              # filter(p_age>=18&p_age<=20)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-w*exp_reg(p_age))
    
      #plot with no age  
    print(ggplot(no_age, aes(x=cq_fail_appear_two_yr, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs Fel5yrs per Person (weight",w,")"))
          )
}

for(a in c(20,24,28,32,36,40,44)){
    no_age=features%>%
              select(person_id, p_age, cq_fail_appear_two_yr,p_violence_raw)%>%
              filter(p_age>=(a-2)&p_age<=(a+2))%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    # print(no_age)
    print(ggplot(no_age, aes(x=cq_fail_appear_two_yr, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs 5yrFel per Person (age range ",a-2,"-",a+2,")"))
          )
}

for(a2 in c(18,20,22,24,26,28,30)){
    no_age=features%>%
              select(person_id, p_age, cq_fail_appear_two_yr,p_violence_raw)%>%
              filter(p_age==a2)%>%
              mutate(age_factor=exp_reg(p_age),
                    raw_minus_age=p_violence_raw-exp_reg(p_age))
    
    print(ggplot(no_age, aes(x=cq_fail_appear_two_yr, y=raw_minus_age)) +
          geom_point(shape=1)  +
          ggtitle(paste0("Risk of Violence Raw vs 5yrFel per Person (age ",a2,")"))
          )
}

```


Categorising based on number of felonies/misdemeanors?
Working with Risk of Violence scores
```{r}
#felonies
ggplot(features, aes(x=p_felony_count_person, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Felonies")


ggplot(features, aes(x=p_yrs5_felcount_person, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Felonies in 5 yrs")

#misdemeanors
ggplot(features, aes(x=p_misdem_count_person, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Misdemeanors")


ggplot(features, aes(x=p_misdem_count_5yrs, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Misdemeanors in 5 yrs")


```
#min(#misdemeanors, 40)

Exploring more relations
# A tibble: 7 x 1		# A tibble: 2 x 1		# A tibble: 6 x 1
     marital_status		     sex		              race
              <chr>		   <chr>		             <chr>
1            Single		1   Male		      1 Native American
2           Married		2 Female		      2 Caucasian
3         Separated				              3 African-American
4           Divorced				            4 Hispanic
5 Significant Other				              5 Asian
6           Widowed				              6 Other
7          Unknown				

```{r}
#Risk of violence and current violent offense 
ggplot(features, aes(x=p_current_violent_offense, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Current Violent Offense")

#Risk of violence vs race
ggplot(features, aes(x=p_race, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Race")


#Risk of violence vs sex
ggplot(features, aes(x=p_sex, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Sex")

#Risk of violence vs marital status
ggplot(features, aes(x=p_marital_status, y=p_violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Marital Status")

```

