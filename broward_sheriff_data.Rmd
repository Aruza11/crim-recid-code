---
title: "Broward Sheriff Data Comparison"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).



```{r}
library(tidyverse)
library(magrittr)
setwd("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/crim-recid-code")

```

Reading in pretrial prescreen dataset which the Broward Sheriff's Office shared with ProPublica
```{r}
pretrialscreen_2013_2014<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/Compas_Jan2013_Dec2014_LegalRequest_PRETRIAL AND PRESCREEN.csv")

pretrialscreen_2014_2017<-read.csv("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/Data tables/Compas_Jan2014_Dec2017_LegalRequest_PRETRIAL AND PRESCREEN.csv")

pretrialscreen<-bind_rows(pretrialscreen_2013_2014,pretrialscreen_2014_2017)
# pretrialscreen$Screening_Date<-as.Date(pretrialscreen$Screening_Date,format="%m/%d/%Y %T")
#the above doesn't work for some reason

rm(pretrialscreen_2013_2014,pretrialscreen_2014_2017)
 
scattertbl1<-filter(pretrialscreen,DisplayText=="Risk of Violence")
scattertbl2<-filter(pretrialscreen,DisplayText=="Risk of Recidivism")
scattertbl3<-filter(pretrialscreen,DisplayText=="Risk of Failure to Appear")

features<-read.csv("features.csv")

```

```{r}
ggplot(pretrialscreen, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Pretrial Prescreen Dataset")

boxplot(RawScore~DisplayText,data=pretrialscreen, main="Distribution of Raw Scores for Each Screening Type", xlab="DisplayText", ylab="RawScore")



print("mean,25th quartile, median, 75th quartile,min,max")
print("Risk of Violence min max raw scores:")
fivenum(scattertbl1$RawScore)


ggplot(scattertbl1, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Scores")

print("Risk of Recidivism min max raw scores:")
fivenum(scattertbl2$RawScore)

ggplot(scattertbl2, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Scores")


print("Risk of Failure to Appear min max raw scores:")
fivenum(scattertbl1$RawScore)

ggplot(scattertbl3, aes(x=RawScore, y=DecileScore)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Scores")



```

Comparison with data from ProPublica, more summary statistics
```{r}
pretrialscreen%>%
        select(LegalStatus)%>%
        unique()

pretrialscreen%>%
        select(AssessmentReason)%>%
        unique()

pretrialscreen%>%
        select(DisplayText)%>%
        unique()


nonprescreen=filter(pretrialscreen,LegalStatus!="Pretrial")
prescreen=filter(pretrialscreen,LegalStatus=="Pretrial")
#compare to people from propublica dataset 

print("min max Screening Dates")
min(pretrialscreen$Screening_Date)
max(pretrialscreen$Screening_Date)


#people who have same raw score, but different decile score. Work with scattertbl3 first, because has integer score values 

# filter(scattertbl3, )

```

LegalStatus
<chr>
1	Conditional Release			
10	Post Sentence			
205	Pretrial			
43143	Other			
4 rows

AssessmentReason
<fctr>
1	Intake			
1 row
 
 
DisplayText
<fctr>
1	Risk of Violence			
2	Risk of Recidivism			
3	Risk of Failure to Appear			
3 rows


Age, number of priors, number of misdemeanors, number of felonies, expect a decision tree (scattered bunches on scatterplot)

Plot people with similar criminal histories, plot age vs compas score
Similar: similar number of  priors, similar number of offenses, 

Issue: we only have the criminal history information for people in ProPublica's dataset, and ProPublica only looked at pretrial people. Therefore we can only look at the Compas algorithm for pretrial screening (and in fact, we will be looking at the features table I generated in an earlier bit of code)

```{r}
ggplot(features, aes(x=age, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Age")

ggplot(features, aes(x=age, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Age")


ggplot(features, aes(x=age, y=recid_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Score vs Age")

ggplot(features, aes(x=age, y=recid_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Recidivism Raw vs Age")


ggplot(features, aes(x=age, y=fail_to_appear_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Score vs Age")

ggplot(features, aes(x=age, y=fail_to_appear_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Failure to Appear Raw vs Age")


```
Categorising based on number of felonies/misdemeanors?
Working with Risk of Violence scores
```{r}
# felonies_0_5<-filter(features,felony_count_person<5)
# felonies_5_10<-filter(features, felony_count_person>=5&felony_count_person<10)

ggplot(features, aes(x=felony_count_person, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Felonies")

ggplot(features, aes(x=felony_count_person, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Number Felonies")

ggplot(features, aes(x=misdem_count_person, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Misdemeanors")

ggplot(features, aes(x=misdem_count_person, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Number Misdemeanors")


#Same as above but with within 5 years felonies/midemeanors 
ggplot(features, aes(x=yrs5_felcount_person, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Felonies")

ggplot(features, aes(x=yrs5_felcount_person, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Number Felonies")

ggplot(features, aes(x=misdem_count_5yrs, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Number Misdemeanors")

ggplot(features, aes(x=misdem_count_5yrs, y=violence_decile)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Score vs Number Misdemeanors")

```
Exploring more relations
# A tibble: 7 x 1		# A tibble: 2 x 1		# A tibble: 6 x 1
     marital_status		     sex		              race
              <chr>		   <chr>		             <chr>
1            Single		1   Male		      1 Native American
2           Married		2 Female		      2 Caucasian
3         Separated				              3 African-American
4           Divorced				            4 Hispanic
5 Significant Other				              5 Asian
6           Widowed				              6 Other
7          Unknown				

```{r}
#Risk of violence and current violent offense 
ggplot(features, aes(x=current_violent_offense, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Current Violent Offense")

#Risk of violence vs race
ggplot(features, aes(x=race, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Race")


#Risk of violence vs sex
ggplot(features, aes(x=sex, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Sex")

#Risk of violence vs marital status
ggplot(features, aes(x=marital_status, y=violence_raw)) +
     geom_point(shape=1)  +
     ggtitle("Risk of Violence Raw vs Marital Status")

```

